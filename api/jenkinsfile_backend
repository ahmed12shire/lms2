pipeline {
    agent {
        label 'docker'
    }
    environment {
        DOCKERHUB_CREDENTIALS = credentials('mydockeruser')
        registry = "vamsisqldba2401/8am-lms-be"
    }
    stages {
        stage('Building the docker image') {
            steps {
                script {
                    def dockerImage = docker.build("vamsisqldba2401/8am-lms-be", "./api")
                    dockerImage.push()
                }
            }
        }
        stage('Pushing the docker image into Docker Hub') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'mydockeruser', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
                        sh "docker login -u $USERNAME -p $PASSWORD"
                        sh "docker push vamsisqldba2401/8am-lms-be"
                    }
                }
            }
        }
        stage('Database and Backend Containers') {
            steps {
                sh 'docker rm -f lmsdb || true'
                sh 'docker run -d -p 5432:5432 --network lmsnetwork -e POSTGRES_PASSWORD=password --name lmsdb postgres'
                sh 'docker rm -f backend || true'
                sh '''
                    docker run -d -p 8080:8080 --network lmsnetwork \
                    -e DATABASE_URL=postgresql://postgres:password@lmsdb:5432/postgres \
                    --name backend -e PORT=8080 -e MODE=local vamsisqldba2401/8am-lms-be
                '''
            }
        }
    }
}
